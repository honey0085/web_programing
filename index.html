<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>반응속도 테스트</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #222;
      color: white;
      font-family: 'Pretendard', sans-serif;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    .container { text-align: center; }

    h1 { font-size: 2em; margin-bottom: 1rem; }

    p { font-size: 1.2em; margin-bottom: 1rem; }

    button {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 12px 28px;
      font-size: 1.1em;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover { background-color: #2563eb; }

    .hidden { display: none; }
  </style>
</head>

<body>
  <div class="container">
    <h1>⚡ 반응속도 테스트</h1>
    <p id="text">"시작하기" 버튼을 눌러주세요!</p>
    <button id="startBtn">시작하기</button>
  </div>

  <script>
    const text = document.getElementById('text');
    const button = document.getElementById('startBtn');

    let startTime = null;
    let timeout = null;
    let currentTrial = 1;
    const totalTrials = 3;
    let results = [];
    let bestRecord = localStorage.getItem('bestRecord');
    bestRecord = bestRecord ? parseInt(bestRecord, 10) : null;

    const reset = () => {
      document.body.style.backgroundColor = '#222';
      text.textContent = '"시작하기" 버튼을 눌러주세요!';
      button.textContent = '시작하기';
      button.classList.remove('hidden');
    };

    const startGame = () => {
      button.classList.add('hidden');
      text.textContent = `(${currentTrial}/${totalTrials}) 곧 색이 바뀝니다... 준비하세요!`;

      document.body.style.backgroundColor = '#b91c1c'; // 빨강
      startTime = null;

      const delay = 2000 + Math.random() * 3000;

      clearTimeout(timeout);
      timeout = setTimeout(() => {
        document.body.style.backgroundColor = '#16a34a'; // 초록
        text.textContent = `(${currentTrial}/${totalTrials}) 지금 클릭!`;
        startTime = Date.now();
      }, delay);
    };

    const finishSession = () => {
      if (results.length === 0) {
        text.innerHTML = `측정된 기록이 없습니다.<br>다시 시도해 주세요.`;
      } else {
        const avg = Math.round(results.reduce((a, b) => a + b) / results.length);
        text.innerHTML = `
          평균 반응속도: <b>${avg}ms</b><br>
          개별 기록: ${results.map(r => r + 'ms').join(' / ')}<br>
          최고기록: ${bestRecord !== null ? bestRecord + 'ms' : '없음'}
        `;
      }

      button.textContent = '다시하기';
      button.classList.remove('hidden');

      // 초기화
      startTime = null;
      timeout = null;
      currentTrial = 1;
      results = [];
      document.body.style.backgroundColor = '#222';
    };

    const handleClick = () => {
      if (!button.classList.contains('hidden')) return;

      if (!startTime) {
        // 조급 클릭
        clearTimeout(timeout);
        text.textContent = `너무 빨랐어요! 같은 라운드를 다시 시도합니다. (${currentTrial}/${totalTrials})`;
        document.body.style.backgroundColor = '#222';

        setTimeout(() => startGame(), 800);
      } else {
        // 정상 클릭 기록
        const reaction = Date.now() - startTime;
        results.push(reaction);

        if (bestRecord === null || reaction < bestRecord) {
          bestRecord = reaction;
          localStorage.setItem('bestRecord', reaction);
        }

        text.innerHTML = `(${currentTrial}/${totalTrials}) 기록: <b>${reaction}ms</b>`;
        document.body.style.backgroundColor = '#222';

        clearTimeout(timeout);
        startTime = null;

        if (currentTrial < totalTrials) {
          currentTrial++;
          setTimeout(() => startGame(), 800);
        } else {
          setTimeout(() => finishSession(), 700);
        }
      }
    };

    // 이벤트
    button.addEventListener('click', () => {
      results = [];
      currentTrial = 1;
      startGame();
    });

    document.body.addEventListener('click', handleClick);

    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        if (button.classList.contains('hidden')) handleClick();
        else {
          results = [];
          currentTrial = 1;
          startGame();
        }
      }
    });

    // 초기 상태
    reset();
  </script>
</body>
</html>
